<div class="page-container">
  <div class="filters-section">
    <h2>Encuentra a tu experto</h2>
    <div class="filters-grid">
      <div class="filter-group">
        <label>Oficio</label>
        <div class="custom-select-wrapper">
          <div class="custom-select-trigger" (click)="toggleDropdown('oficio', $event)">
            <span>{{ filtros.oficio || 'Todos' }}</span>
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </div>
          @if (dropdownOpen === 'oficio') {
          <ul class="suggestions-list custom-dropdown">
            <li (click)="seleccionarOficio('')" class="suggestion-item">Todos</li>
            @for (oficio of oficiosDisponibles(); track $index) {
            <li (click)="seleccionarOficio(oficio)" class="suggestion-item">{{oficio}}</li>
            }
          </ul>
          }
        </div>
      </div>

      <div class="filter-group">
        <label>Barrio</label>
        <div class="search-wrapper">
          <input type="text" [(ngModel)]="filtros.ciudad" (input)="buscarCiudades($event)" placeholder="Escribe un barrio..." class="input-filter">
          @if (cityFilterSuggestions().length > 0) {
          <ul class="suggestions-list">
            @for (barrio of cityFilterSuggestions(); track barrio.lat) {
            <li (click)="seleccionarCiudadFiltroManual(barrio)" class="suggestion-item">{{ barrio.nombre }}</li>
            }
          </ul>
          }
        </div>
      </div>

      <div class="filter-group">
        <label>Ordenar por</label>
        <div class="custom-select-wrapper">
          <div class="custom-select-trigger" (click)="toggleDropdown('orden', $event)">
            <span>
              {{ criterioOrden() === 'calificacion' ? 'Mejor Calificaci√≥n' :
              criterioOrden() === 'nombre' ? 'Nombre (A-Z)' : 'Cercan√≠a (Por defecto)' }}
            </span>
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </div>

          @if (dropdownOpen === 'orden') {
          <ul class="suggestions-list custom-dropdown">
            <li (click)="seleccionarOrden('')" class="suggestion-item">Cercan√≠a (Por defecto)</li>
            <li (click)="seleccionarOrden('calificacion')" class="suggestion-item">Mejor Calificaci√≥n</li>
            <li (click)="seleccionarOrden('nombre')" class="suggestion-item">Nombre (A-Z)</li>
          </ul>
          }
        </div>
      </div>

      <div class="filter-actions">
        <button (click)="obtenerUbicacionGPS()" class="btn-ubicacion">üìç Mi Ubicaci√≥n</button>
        <button class="map-toggle-btn" (click)="toggleMap()">
          @if (showMap()) { <span>Ocultar Mapa</span> } @else { <span>Ver Mapa</span> }
        </button>
        <button class="cta-button-outline" (click)="limpiarFiltros()">Limpiar</button>
        <button class="cta-button" (click)="aplicarFiltros()">Buscar</button>
      </div>
    </div>
  </div>

  <div class="layout-grid" [class.map-hidden]="!showMap()">
    <div class="list-column">
      <div class="especialistas-grid">
        @for (esp of especialistasVisibles(); track esp.email) {
        <article class="esp-card" (click)="irAEspecialistaEnMapa(esp)" style="cursor: pointer;">
          <div class="card-header">
            <div class="avatar-card-wrapper">
              @if (esp.fotoUrl) {
              <img [src]="esp.fotoUrl" class="avatar-img-small" alt="Foto de {{ esp.nombre }}">
              } @else {
              <div class="avatar-initials-small fallback-orange">
                {{ esp.nombre.charAt(0) }}{{ esp.apellido.charAt(0) }}
              </div>
              }
            </div>
            <div class="header-info">
              <h3>{{ esp.nombre }} {{ esp.apellido }}</h3>
              <span class="city-badge">{{ esp.ciudad }}</span>
            </div>
            <div class="header-actions">
              <button class="icon-action-btn" [class.fav-active]="esFavorito(esp.email)" (click)="toggleFavorito(esp, $event)">
                @if (esFavorito(esp.email)) {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                  <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" />
                </svg>
                } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
                </svg>
                }
              </button>
              <button class="icon-action-btn" (click)="$event.stopPropagation(); abrirModalDetalle(esp)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="rating">‚≠ê {{ esp.calificacionPromedio }}</div>
            <div class="oficios-list">
              @for (oficio of esp.oficios; track $index) {
              <span class="oficio-tag">{{ oficio }}</span>
              }
            </div>
          </div>
          <div class="card-footer">
            <button class="cta-button full-width" (click)="$event.stopPropagation(); abrirModalContratar(esp)">Contratar</button>
          </div>
        </article>
        }
      </div>

      @if (totalPages() > 1) {
      <div class="pagination-bar">
        <button [disabled]="currentPage() === 0" (click)="cambiarPagina(currentPage() - 1)">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6" />
          </svg>
          Anterior
        </button>
        <span class="pagination-info">P√°gina {{ currentPage() + 1 }} de {{ totalPages() }}</span>
        <button [disabled]="currentPage() + 1 >= totalPages()" (click)="cambiarPagina(currentPage() + 1)">
          Siguiente
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m9 18 6-6-6-6" />
          </svg>
        </button>
      </div>
      }
    </div>
    <aside class="map-column" [hidden]="!showMap()">
      <div class="map-card-container">
        <div id="map"></div>
      </div>
    </aside>
  </div>
</div>

@if (showModalDetalle()) {
<div class="modal-overlay" (click)="cerrarModalDetalle()">
  <div class="modal-card profile-modal" (click)="$event.stopPropagation()">
    <button class="close-corner-btn" (click)="cerrarModalDetalle()">‚úï</button>
    @if (isLoadingDetalle() || !especialistaSeleccionaCompleto()) {
    <div class="loading-state">
      <p>Cargando perfil...</p>
    </div>
    } @else {
    <div class="profile-header-modal">
      <div class="avatar-large-wrapper">
        @if (especialistaSeleccionaCompleto()?.fotoUrl) {
        <img [src]="especialistaSeleccionaCompleto()?.fotoUrl" class="avatar-img-large" alt="Perfil">
        } @else {
        <div class="avatar-initials-large fallback-orange">
          {{ especialistaSeleccionaCompleto()?.nombre?.charAt(0) }}{{ especialistaSeleccionaCompleto()?.apellido?.charAt(0) }}
        </div>
        }
      </div>
      <h2>{{ especialistaSeleccionaCompleto()?.nombre }} {{ especialistaSeleccionaCompleto()?.apellido }}</h2>
      <p class="profile-city">üìç {{ especialistaSeleccionaCompleto()?.ciudad }}</p>
      <div class="rating-large">‚≠ê {{ especialistaSeleccionaCompleto()?.calificacionPromedio }} <span class="rating-count">/ 5.0</span></div>
    </div>
    <div class="profile-body-modal">
      <h4>Sobre m√≠</h4>
      <p class="desc-text">{{ especialistaSeleccionaCompleto()?.descripcion || 'Sin descripci√≥n.' }}</p>
      <div class="contact-info">
        <p><strong>Email:</strong> {{ especialistaSeleccionaCompleto()?.email }}</p>
        <p><strong>Tel√©fono:</strong> {{ especialistaSeleccionaCompleto()?.telefono }}</p>
      </div>
    </div>
    <div class="profile-actions-modal">
      <button class="btn-secondary-icon" [class.fav-active]="esFavorito(especialistaSeleccionaCompleto()?.email)" (click)="toggleFavorito(especialistaSeleccionaCompleto())">
        @if (esFavorito(especialistaSeleccionaCompleto()?.email)) {
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" />
        </svg>
        } @else {
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
        </svg>
        }
      </button>
      <button class="cta-button grow" (click)="abrirModalContratar(especialistaSeleccionaCompleto())">Contratar Ahora</button>
    </div>
    }
  </div>
</div>
}

@if (showModalContratar()) {
<div class="modal-overlay" (click)="cerrarModalContratar()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <h3>Solicitar Servicio</h3>
    <p class="modal-desc">Para: <strong>{{ especialistaSeleccionado?.nombre }}</strong></p>
    <textarea [(ngModel)]="descripcionTrabajo" rows="4" placeholder="Describe tu problema..."></textarea>
    <div class="modal-actions">
      <button class="cta-button-outline" (click)="cerrarModalContratar()">Cancelar</button>
      <button class="cta-button" (click)="enviarSolicitud()" [disabled]="isSubmitting() || !descripcionTrabajo">Enviar</button>
    </div>
  </div>
</div>
}

@if (feedbackData.visible) {
<app-modal-feedback [titulo]="feedbackData.titulo" [mensaje]="feedbackData.mensaje" [tipo]="feedbackData.tipo" (cerrar)="cerrarFeedback()"></app-modal-feedback>
}
