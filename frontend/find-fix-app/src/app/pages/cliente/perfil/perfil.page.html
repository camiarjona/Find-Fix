<div class="profile-page-container">

  <div class="page-header">
    <h1>Configuración de Perfil</h1>
    <p>Gestiona tu información personal y la seguridad de tu cuenta</p>
  </div>

  @if (isLoading()) {
  <div class="loading-state">Cargando perfil...</div>
  } @else {

  <div class="profile-grid">

    <section class="card personal-info-card">
      <div class="card-header">
        <div class="header-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" width="24" height="24"
            stroke-width="1.3" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="icons.USER" />
          </svg></div>
        <h2>Información Personal</h2>
      </div>

      <div class="card-body">
        <div class="user-banner">
          <div class="avatar-circle">
            {{ usuario()?.nombre?.charAt(0) }}{{ usuario()?.apellido?.charAt(0) }}
          </div>
          <div class="user-names">
            <h3>{{ usuario()?.nombre }} {{ usuario()?.apellido }}</h3>
            <span class="role-badge">{{ usuario()?.roles?.[0] }}</span>
          </div>
        </div>

        <ul class="data-list">
          <li class="data-item">
            <span class="label">Nombre</span>
            <div class="value-container">
              @if (editingField() === 'nombre') {
              <div class="edit-mode">
                <input type="text" [(ngModel)]="tempValue" class="input-inline">
                <button class="action-btn save" (click)="saveEdit('nombre')"><svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                    <path [attr.d]="icons.SAVE">
                    </path>
                  </svg></button>
                <button class="action-btn cancel" (click)="cancelEdit()"><svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                    <path [attr.d]="icons.CANCEL">
                    </path>
                  </svg></button>
              </div>
              } @else {
              <span class="value">{{ usuario()?.nombre }}</span>
              <button class="edit-pencil" (click)="startEdit('nombre', usuario()?.nombre)"><svg
                  xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                  <path [attr.d]="icons.EDIT">
                  </path>
                </svg></button>
              }
            </div>
          </li>

          <li class="data-item">
            <span class="label">Apellido</span>
            <div class="value-container">
              @if (editingField() === 'apellido') {
              <div class="edit-mode">
                <input type="text" [(ngModel)]="tempValue" class="input-inline">
                <button class="action-btn save" (click)="saveEdit('apellido')"><svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                    <path [attr.d]="icons.SAVE">
                    </path>
                  </svg></button>
                <button class="action-btn cancel" (click)="cancelEdit()"><svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                    <path [attr.d]="icons.CANCEL">
                    </path>
                  </svg></button>
              </div>
              } @else {
              <span class="value">{{ usuario()?.apellido }}</span>
              <button class="edit-pencil" (click)="startEdit('apellido', usuario()?.apellido)"><svg
                  xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                  <path [attr.d]="icons.EDIT">
                  </path>
                </svg></button>
              }
            </div>
          </li>

          <li class="data-item">
            <span class="label">Email</span>
            <div class="value-container">
              <span class="value locked">{{ usuario()?.email }}</span>
              <span class="lock-icon" title="No editable"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                  fill="#000000" viewBox="0 0 24 24">
                  <path [attr.d]="icons.LOCK"></path>
                </svg></span>
            </div>
          </li>

          <li class="data-item">
            <span class="label">Teléfono</span>
            <div class="value-container">
              @if (editingField() === 'telefono') {
              <div class="edit-mode">
                <input type="text" [(ngModel)]="tempValue" class="input-inline">
                <button class="action-btn save" (click)="saveEdit('telefono')"><svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                    <path [attr.d]="icons.SAVE">
                    </path>
                  </svg></button>
                <button class="action-btn cancel" (click)="cancelEdit()"><svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                    <path [attr.d]="icons.CANCEL">
                    </path>
                  </svg></button>
              </div>
              } @else {
              <span class="value">{{ usuario()?.telefono || 'No especificado' }}</span>
              <button class="edit-pencil" (click)="startEdit('telefono', usuario()?.telefono)"><svg
                  xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                  <path [attr.d]="icons.EDIT">
                  </path>
                </svg></button>
              }
            </div>
          </li>

          <li class="data-item">
            <span class="label">Ciudad</span>
            <div class="value-container">
              @if (editingField() === 'ciudad') {
              <div class="edit-mode">
                <select [(ngModel)]="tempValue" class="input-inline">
                  @for (city of availableCities(); track city) {
                  <option [value]="city">{{ city }}</option>
                  }
                </select>
                <button class="action-btn save" (click)="saveEdit('ciudad')"><svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                    <path [attr.d]="icons.SAVE">
                    </path>
                  </svg></button>
                <button class="action-btn cancel" (click)="cancelEdit()"><svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                    <path [attr.d]="icons.CANCEL">
                    </path>
                  </svg></button>
              </div>
              } @else {
              <span class="value">{{ usuario()?.ciudad || 'No especificada' }}</span>
              <button class="edit-pencil" (click)="startEdit('ciudad', usuario()?.ciudad)"><svg
                  xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                  <path [attr.d]="icons.EDIT">
                  </path>
                </svg></button>
              }
            </div>
          </li>
        </ul>
      </div>
    </section>

    <section class="card security-card">
      <div class="card-header">
        <div class="header-icon locked-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" width="24" height="24"
            stroke-width="1.3" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="icons.ESCUDO" />
          </svg></div>
        <h2>Seguridad</h2>
      </div>

      <div class="card-body">
        <form (ngSubmit)="changePassword()" class="security-form">
          <div class="form-group">
            <label>Contraseña Actual</label>
            <input type="password" [(ngModel)]="passwordData.passwordActual" name="currPass" placeholder="••••••"
              required>
          </div>

          <div class="form-group">
            <label>Nueva Contraseña</label>
            <input type="password" [(ngModel)]="passwordData.passwordNuevo" name="newPass"
              placeholder="Mínimo 6 caracteres" required>
          </div>

          <div class="form-group">
            <label>Confirmar Nueva Contraseña</label>
            <input type="password" [(ngModel)]="passwordData.confirmacion" name="confPass"
              placeholder="Repite la nueva contraseña" required>
          </div>

          <button type="submit" class="btn-full-width" [disabled]="isPasswordLoading()">
            {{ isPasswordLoading() ? 'Actualizando...' : 'Cambiar Contraseña' }}
          </button>
        </form>
      </div>
    </section>

  </div>
  }
</div>
