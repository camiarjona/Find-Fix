  <div class="page-header">
    <h1>Configuraci√≥n de Perfil</h1>
    <p>Gestiona tu informaci√≥n personal y la seguridad de tu cuenta</p>
  </div>

  @if (isLoading()) {
  <div class="loading-state">Cargando perfil...</div>
  } @else {

 <div class="profile-hero-section">
  <div class="avatar-container">
    <div class="avatar-wrapper" (click)="isEditingPhoto.set(true)">
      @if (perfil()?.fotoUrl && !fotoError()) {
        <img [src]="perfil()?.fotoUrl" class="main-avatar" (error)="fotoError.set(true)">
      } @else {
        <div class="avatar-initials">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 80px; height: 80px;">
            <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="#CCCCCC"/>
          </svg>
        </div>
      }
      <div class="avatar-overlay">
        <i class="fas fa-camera"></i>
        <span>EDITAR</span>
      </div>
      <div class="edit-badge"><i class="fas fa-pencil-alt"></i></div>
    </div>

    <div class="hero-info">
  <h3>{{ perfil()?.nombre }} {{ perfil()?.apellido }}</h3>

  <div class="oficios-hero-container">
    @for (oficio of perfil()?.oficios; track oficio.id) {
      <span class="role-badge">{{ oficio.nombre }}</span>
    } @empty {
      <span class="role-badge" style="background-color: #fef3c7; color: #92400e;">
        Sin oficios registrados
      </span>
    }
  </div>
</div>
  </div>

  <div class="photo-editor-backdrop" *ngIf="isEditingPhoto()" (click)="cancelarCambioFoto()">
    <div class="photo-editor-modal" (click)="$event.stopPropagation()">

      <button class="modal-close-btn" (click)="cancelarCambioFoto()">
        <span>&times;</span>
      </button>

      <div class="modal-content-layout">
        <div class="editor-column">
          <p class="column-label">Vista Previa</p>
          <div class="large-circle-preview">
            @if (tempPhotoUrl()) {
              <img [src]="tempPhotoUrl()" alt="Vista previa">
            } @else {
              <i class="fas fa-user" style="font-size: 3rem; color: #eee;"></i>
            }
          </div>
        </div>

        <div class="editor-column">
          <p class="column-label">Nueva Imagen</p>
          <ngx-dropzone (change)="onSelect($event)" [multiple]="false" accept="image/*" class="clean-dropzone-orange">
            <ngx-dropzone-label style="width: 100%; height: 100%;">
              <div class="drop-instructions" *ngIf="!tempPhotoUrl()">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Seleccionar foto</span>
              </div>
              <div class="custom-preview" *ngIf="tempPhotoUrl()">
                <img [src]="tempPhotoUrl()" class="preview-img">
                <button class="remove-btn-overlay" (click)="$event.stopPropagation(); onRemove(files[0])">
                  <span>&times;</span>
                </button>
              </div>
            </ngx-dropzone-label>
          </ngx-dropzone>
        </div>
      </div>

      <div class="modal-footer">
        <div class="left-actions">
          @if (perfil()?.fotoUrl) {
            <button class="btn-action btn-delete-photo" (click)="eliminarFotoActual()">
              <i class="fas fa-trash-alt"></i> Eliminar Foto
            </button>
          }
          <button class="btn-action btn-discard-new" (click)="cancelarCambioFoto()">
            Descartar
          </button>
        </div>

        <button class="btn-action btn-save-new"
                [disabled]="files.length === 0 || isPhotoLoading()"
                (click)="guardarFoto()">
          <i class="fas fa-check" *ngIf="!isPhotoLoading()"></i>
          {{ isPhotoLoading() ? 'Subiendo...' : 'Guardar Cambios' }}
        </button>
      </div>

    </div>
  </div>
</div>
}

  <div class="profile-grid">

    <section class="card personal-info-card">
      <div class="card-header">
        <div class="header-icon">
          <svg class="sol-esp" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.2"
            width="40" height="40" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h8l-1-3a4 4 0 0 0-6 0l-1 3z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v2" />
            <circle cx="12" cy="13" r="2.5" stroke="currentColor" stroke-width="1.2" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.5 13.2h-.5m6 0h-.5" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 20c1-3 3-5 5-5s4 2 5 5" />
          </svg>
        </div>
        <h2>Informaci√≥n Profesional</h2>
      </div>

      <div class="card-body">
        <ul class="data-list">

          <li class="data-item bio-item">
            <div class="label-row">
              <span class="label">Sobre M√≠</span>
              @if (editingField() !== 'descripcion') {
              <button class="edit-pencil" (click)="startEdit('descripcion', perfil()?.descripcion)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                  <path [attr.d]="icons.EDIT"></path>
                </svg>
              </button>
              }
            </div>
            <div class="value-container full-width">
              @if (editingField() === 'descripcion') {
              <div class="edit-mode column-mode">
                <textarea [(ngModel)]="tempValue" class="input-inline textarea-bio" rows="4"
                  placeholder="Cu√©ntale a los clientes sobre tu experiencia..."></textarea>
                <div class="actions-row">
                  <button class="action-btn save" (click)="saveEdit('descripcion')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                      <path [attr.d]="icons.SAVE"></path>
                    </svg>
                  </button>
                  <button class="action-btn cancel" (click)="cancelEdit()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                      <path [attr.d]="icons.CANCEL"></path>
                    </svg>
                  </button>
                </div>
              </div>
              } @else {
              <p class="bio-text">{{ perfil()?.descripcion || 'Agrega una descripci√≥n para destacar tu perfil.' }}</p>
              }
            </div>
          </li>

          <li class="data-item oficios-item">
            <div class="label-row">
              <span class="label">Mis Oficios</span>
              @if (!isAddingOficio()) {
              <button class="add-btn" (click)="isAddingOficio.set(true)">+ Agregar</button>
              }
            </div>
            <div class="oficios-list">
              @for (oficio of perfil()?.oficios; track oficio.id) {
              <span class="oficio-chip">
                {{ oficio.nombre }}
                <button class="chip-remove" (click)="promptRemoveOficio(oficio.nombre)" title="Eliminar">√ó</button>
              </span>
              }
            </div>
            @if (isAddingOficio()) {
            <div class="add-oficio-form">
              <select [(ngModel)]="selectedOficioToAdd" class="input-inline">
                <option value="" disabled selected>Selecciona un oficio</option>
                @for (opcion of selectableOficios(); track opcion.id) {
                <option [value]="opcion.nombre">{{ opcion.nombre }}</option>
                }
              </select>
              <button class="action-btn save" (click)="addOficio()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                  <path [attr.d]="icons.SAVE"></path>
                </svg>
              </button>
              <button class="action-btn cancel" (click)="isAddingOficio.set(false)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24">
                  <path [attr.d]="icons.CANCEL"></path>
                </svg>
              </button>
            </div>
            }
          </li>

          <li class="data-item">
            <span class="label">Email</span>
            <div class="value-container">
              <span class="value locked">{{ perfil()?.email }} <svg xmlns="http://www.w3.org/2000/svg" width="24"
                    height="24" fill="#000000" viewBox="0 0 24 24">
                    <path [attr.d]="icons.LOCK"></path>
                  </svg></span>
            </div>
          </li>

          <li class="data-item">
            <span class="label">DNI</span>
            <div class="value-container">
              @if (editingField() === 'dni') {
              <div class="edit-mode">
                <input type="number" [(ngModel)]="tempValue" class="input-inline" placeholder="Sin puntos">
                <button class="action-btn save" (click)="saveEdit('dni')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24"><path [attr.d]="icons.SAVE"></path></svg>
                </button>
                <button class="action-btn cancel" (click)="cancelEdit()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24"><path [attr.d]="icons.CANCEL"></path></svg>
                </button>
              </div>
              } @else {
              <span class="value">{{ perfil()?.dni || 'No registrado' }}</span>
              <button class="edit-pencil" (click)="startEdit('dni', perfil()?.dni)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24"><path [attr.d]="icons.EDIT"></path></svg>
              </button>
              }
            </div>
          </li>

          <li class="data-item">
            <span class="label">Tel√©fono</span>
            <div class="value-container">
              @if (editingField() === 'telefono') {
              <div class="edit-mode">
                <input type="text" [(ngModel)]="tempValue" class="input-inline">
                <button class="action-btn save" (click)="saveEdit('telefono')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24"><path [attr.d]="icons.SAVE"></path></svg>
                </button>
                <button class="action-btn cancel" (click)="cancelEdit()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24"><path [attr.d]="icons.CANCEL"></path></svg>
                </button>
              </div>
              } @else {
              <span class="value">{{ perfil()?.telefono }}</span>
              <button class="edit-pencil" (click)="startEdit('telefono', perfil()?.telefono)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24"><path [attr.d]="icons.EDIT"></path></svg>
              </button>
              }
            </div>
          </li>

<li class="data-item">
  <span class="label">Zona de Trabajo</span>
  <div class="value-container">
    @if (editingField() === 'ciudad') {
    <div class="edit-mode">
      <div class="horizontal-group" style="display: flex; align-items: center; gap: 5px; width: 100%;">
        <div class="search-wrapper" style="position: relative; flex: 1; display: flex; align-items: center;">
          <input
            type="text"
            [value]="tempValue"
            (input)="buscarZona($event)"
            class="input-inline"
            placeholder="Ej: Los Troncos, Mar del Plata"
            style="flex: 1; padding-right: 35px;"
           >

          <button type="button" class="btn-inside-input-perfil" (click)="detectarYGuardarZona()" title="Usar GPS">
            <svg viewBox="0 0 16 16" fill="currentColor" height="18" width="18" xmlns="http://www.w3.org/2000/svg">
             <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6"/>
            </svg>
          </button>

          @if (citySuggestions().length > 0) {
          <ul class="suggestions-list">
            @for (sug of citySuggestions(); track sug.lat) {
            <li (click)="seleccionarZona(sug)" class="suggestion-item">
              {{ sug.nombreVisual }}
            </li>
            }
          </ul>
          }
        </div>

        <div class="actions" style="display: flex; gap: 5px;">
          <button class="action-btn save" (click)="saveEdit('ciudad')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24"><path [attr.d]="icons.SAVE"></path></svg>
          </button>
          <button class="action-btn cancel" (click)="cancelEdit()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24"><path [attr.d]="icons.CANCEL"></path></svg>
          </button>
        </div>
      </div>
    </div>
    } @else {
    <span class="value">{{ perfil()?.ciudad || 'No especificada' }}</span>
    <button class="edit-pencil" (click)="startEdit('ciudad', perfil()?.ciudad)">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#000000" viewBox="0 0 24 24"><path [attr.d]="icons.EDIT"></path></svg>
    </button>
    }
  </div>
</li>
        </ul>
      </div>
    </section>

    <section class="card security-card">
      <div class="card-header">
        <div class="header-icon locked-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" width="30" height="30" stroke-width="1.3" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="icons.ESCUDO" />
          </svg>
        </div>
        <h2>Seguridad</h2>
      </div>

      <div class="card-body">
        <form (ngSubmit)="changePassword()" class="security-form">
          <div class="form-group">
            <label>Contrase√±a Actual</label>
            <div class="password-wrapper">
              <input [type]="showCurrentPass() ? 'text' : 'password'" [(ngModel)]="passwordData.passwordActual" name="curr" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
              <button type="button" class="toggle-btn" (click)="togglePass('curr')">
                <svg *ngIf="showCurrentPass()" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                <svg *ngIf="!showCurrentPass()" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>Nueva Contrase√±a</label>
            <div class="password-wrapper">
              <input [type]="showNewPass() ? 'text' : 'password'" [(ngModel)]="passwordData.passwordNuevo" name="new" placeholder="M√≠nimo 6 caracteres" required>
              <button type="button" class="toggle-btn" (click)="togglePass('new')">
                  üëÅÔ∏è
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>Confirmar Nueva</label>
            <div class="password-wrapper">
              <input [type]="showConfirmPass() ? 'text' : 'password'" [(ngModel)]="passwordData.confirmacion" name="conf" placeholder="Rep√≠tela" required>
              <button type="button" class="toggle-btn" (click)="togglePass('conf')">
                  üëÅÔ∏è
              </button>
            </div>
          </div>
          <button type="submit" class="btn-full-width" [disabled]="isPasswordLoading()">
            {{ isPasswordLoading() ? 'Actualizando...' : 'Cambiar Contrase√±a' }}
          </button>
        </form>
      </div>
    </section>

  </div>

@if (feedbackData.visible) {
<app-modal-feedback
  [class.modal-sin-boton]="feedbackData.titulo === 'Ubicando...'"
  [titulo]="feedbackData.titulo"
  [mensaje]="feedbackData.mensaje"
  [tipo]="feedbackData.tipo"
  (cerrar)="cerrarFeedback()">
</app-modal-feedback>
}

@if (oficioToRemove) {
<app-modal-confirmacion [titulo]="'Confirmar eliminaci√≥n'" [mensaje]="'¬øDejar de ofrecer servicios de ' + oficioToRemove + '?'" (cancelar)="cancelRemoveOficio()" (confirmar)="confirmRemoveOficio()"></app-modal-confirmacion>
}
